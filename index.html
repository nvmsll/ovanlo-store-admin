<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | OvanLo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;800&display=swap');
        body { font-family: 'Kanit', sans-serif; }
        .tab-active { background-color: #334155 !important; color: white !important; }
    </style>
</head>
<body class="bg-slate-900 min-h-screen p-4 md:p-6 text-slate-200">
    <div class="max-w-7xl mx-auto">
        
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 border-b border-slate-800 pb-6">
            <div>
                <h1 class="text-3xl font-black italic text-white">OVANLO <span class="text-blue-500">CONTROL</span></h1>
                <p class="text-xs text-slate-500 font-bold uppercase tracking-wider">Dashboard & System Control</p>
            </div>
            
            <div class="flex flex-wrap items-center gap-3">
                <div class="flex items-center gap-2 bg-slate-800 p-2 px-4 rounded-2xl border border-slate-700 shadow-inner">
                    <div class="flex flex-col mr-2">
                        <span class="text-[9px] font-black text-slate-500 uppercase">Pre-order Status</span>
                        <span id="system-status-text" class="text-[10px] font-bold">Checking...</span>
                    </div>
                    <button id="system-toggle-btn" data-status="loading" onclick="toggleSystem()" class="px-4 py-2 rounded-xl text-xs font-black transition-all">
                        Loading...
                    </button>
                </div>
                <button onclick="resetDaily()" class="text-[10px] text-red-400 border border-red-400/30 px-4 py-3 rounded-2xl hover:bg-red-400/10 transition font-black uppercase tracking-wider">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
            </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-8">
            <div class="bg-slate-800 p-4 rounded-3xl border border-slate-700 shadow-lg">
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏Å‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                <div class="flex items-end gap-2 text-white">
                    <span id="stat-cups" class="text-3xl font-black text-blue-500">0</span>
                    <span class="text-xs text-slate-500 mb-1 font-bold">‡πÅ‡∏Å‡πâ‡∏ß</span>
                </div>
            </div>
            
            <div class="bg-slate-800 p-4 rounded-3xl border border-slate-700 shadow-lg ring-1 ring-blue-500/20">
                <p class="text-[10px] text-blue-400 font-bold uppercase tracking-wider mb-1">‡∏¢‡∏≠‡∏î Pre-Order</p>
                <div class="flex items-end gap-1 text-white">
                    <span id="stat-income-pre" class="text-2xl font-black text-blue-400">0</span>
                    <span class="text-[10px] text-slate-500 mb-1 font-bold italic">‡∏ø</span>
                </div>
            </div>

            <div class="bg-slate-800 p-4 rounded-3xl border border-slate-700 shadow-lg ring-1 ring-orange-500/20">
                <p class="text-[10px] text-orange-400 font-bold uppercase tracking-wider mb-1">‡∏¢‡∏≠‡∏î Walk-in</p>
                <div class="flex items-end gap-1 text-white">
                    <span id="stat-income-walk" class="text-2xl font-black text-orange-400">0</span>
                    <span class="text-[10px] text-slate-500 mb-1 font-bold italic">‡∏ø</span>
                </div>
            </div>

            <div class="bg-slate-800 p-4 rounded-3xl border border-slate-700 shadow-lg bg-gradient-to-br from-slate-800 to-slate-900 ring-2 ring-green-500/30">
                <p class="text-[10px] text-green-400 font-bold uppercase tracking-wider mb-1">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                <div class="flex items-end gap-1 text-white">
                    <span id="stat-income-total" class="text-3xl font-black text-green-500">0</span>
                    <span class="text-xs text-slate-500 mb-1 font-bold">‡∏ø</span>
                </div>
            </div>

            <div class="bg-slate-800 p-4 rounded-3xl border border-slate-700 shadow-lg hidden lg:block">
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏Ñ‡πâ‡∏≤‡∏á</p>
                <div class="flex items-end gap-2 text-slate-200">
                    <span id="stat-pending" class="text-2xl font-bold text-orange-400">0</span>
                    <span class="text-xs text-slate-500 mb-1 font-bold uppercase">‡∏Ñ‡∏¥‡∏ß</span>
                </div>
            </div>
        </div>

        <div class="flex flex-wrap gap-2 mb-8 bg-slate-800 p-2 rounded-2xl border border-slate-700">
            <button onclick="setFilter('all')" id="btn-all" class="filter-btn flex-1 py-2 px-4 rounded-xl text-sm font-bold tab-active transition">‡∏Ñ‡∏¥‡∏ß‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button>
            <button onclick="setFilter('pre-order')" id="btn-pre" class="filter-btn flex-1 py-2 px-4 rounded-xl text-sm font-bold text-slate-400 hover:bg-slate-700 transition">Pre-Order</button>
            <button onclick="setFilter('walk-in')" id="btn-walk" class="filter-btn flex-1 py-2 px-4 rounded-xl text-sm font-bold text-slate-400 hover:bg-slate-700 transition">Walk-in</button>
            <button onclick="setFilter('history')" id="btn-history" class="filter-btn flex-1 py-2 px-4 rounded-xl text-sm font-bold text-slate-400 hover:bg-green-600/20 hover:text-green-400 transition">‚úÖ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button>
        </div>

        <div id="admin-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
    </div>

    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyAvEPPZeDB60O0mpGhxKEKQXlzyDgUdl1Q", 
            authDomain: "ovanlo-store.firebaseapp.com", 
            databaseURL: "https://ovanlo-store-default-rtdb.asia-southeast1.firebasedatabase.app", 
            projectId: "ovanlo-store", 
            storageBucket: "ovanlo-store.firebasestorage.app", 
            messagingSenderId: "579028697785", 
            appId: "1:579028697785:web:ac3d3b30cb3533753e9168" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const storage = firebase.storage();

        let currentFilter = 'all'; 
        let allOrders = {};

        // --- System Toggle ---
        function toggleSystem() {
            const btn = document.getElementById('system-toggle-btn');
            const currentStatus = btn.getAttribute('data-status');
            if (currentStatus === "loading") return;
            const isCurrentlyOpen = (currentStatus === 'true');
            const action = isCurrentlyOpen ? "‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏±‡∏ö" : "‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö";
            if(confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ${action} Pre-order ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                db.ref('system_status/preorder_open').set(!isCurrentlyOpen);
            }
        }

        db.ref('system_status/preorder_open').on('value', (snap) => {
            const isOpen = snap.val() !== false; 
            const btn = document.getElementById('system-toggle-btn');
            const statusText = document.getElementById('system-status-text');
            btn.setAttribute('data-status', isOpen);
            if(isOpen) {
                statusText.innerText = "ONLINE";
                statusText.className = "text-[10px] font-black text-emerald-500 tracking-widest";
                btn.innerText = '‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå';
                btn.className = 'px-4 py-2 rounded-xl text-xs font-black bg-red-500/10 text-red-500 border border-red-500/20 hover:bg-red-50 hover:text-white transition-all';
            } else {
                statusText.innerText = "OFFLINE";
                statusText.className = "text-[10px] font-black text-red-500 tracking-widest";
                btn.innerText = '‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå';
                btn.className = 'px-4 py-2 rounded-xl text-xs font-black bg-emerald-500 text-white hover:bg-emerald-600 transition-all shadow-lg shadow-emerald-500/20';
            }
        });

        // --- Core Logic ---
        function setFilter(type) {
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('tab-active'));
            const btnMap = { 'all':'btn-all', 'pre-order':'btn-pre', 'walk-in':'btn-walk', 'history':'btn-history' };
            document.getElementById(btnMap[type]).classList.add('tab-active');
            renderOrders();
        }

        db.ref('orders').on('value', (snap) => {
            allOrders = snap.val() || {};
            renderOrders();
        });

        function updateDashboard() {
            let totalCups = 0;
            let incomePre = 0;   // ‡∏¢‡∏≠‡∏î Pre-order
            let incomeWalk = 0;  // ‡∏¢‡∏≠‡∏î Walk-in
            let pendingOrders = 0;

            Object.values(allOrders).forEach(order => {
                const type = (order.type || "").toLowerCase();
                
                if (order.status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß') {
                    totalCups += (order.items ? order.items.length : 0);
                    const price = (order.totalPrice || 0);
                    
                    if (type === 'pre-order') {
                        incomePre += price;
                    } else {
                        incomeWalk += price;
                    }
                } else if (order.status === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' || order.status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∏‡∏á') {
                    pendingOrders++;
                }
            });

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            document.getElementById('stat-cups').innerText = totalCups.toLocaleString();
            document.getElementById('stat-income-pre').innerText = incomePre.toLocaleString();
            document.getElementById('stat-income-walk').innerText = incomeWalk.toLocaleString();
            document.getElementById('stat-income-total').innerText = (incomePre + incomeWalk).toLocaleString();
            document.getElementById('stat-pending').innerText = pendingOrders.toLocaleString();
        }

        function renderOrders() {
            updateDashboard();
            const container = document.getElementById('admin-list');
            container.innerHTML = "";
            const keys = Object.keys(allOrders).reverse();
            let count = 0;

            keys.forEach(key => {
                const order = allOrders[key];
                const type = (order.type || "").toLowerCase();
                const status = order.status;

                if (currentFilter === 'history') {
                    if (status !== '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß') return;
                } else {
                    if (status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß' || status === '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å') return;
                    if (currentFilter === 'pre-order' && type !== 'pre-order') return;
                    if (currentFilter === 'walk-in' && type !== 'walk-in') return;
                }

                count++;
                const isPre = type === 'pre-order';
                const isProc = status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∏‡∏á';
                const isDone = status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß';
                
                const card = document.createElement('div');
                let cardStyle = isProc ? "bg-green-50 ring-4 ring-green-500 shadow-green-500/20" : (isDone ? "bg-slate-800 opacity-90 border-slate-700" : "bg-white");
                card.className = `p-5 rounded-3xl shadow-xl transition-all duration-300 ${cardStyle} text-slate-900 flex flex-col border border-slate-100`;
                if(isDone) card.classList.add('text-slate-400');

                let payBadge = "";
                if(order.payment) {
                    const payColor = order.payment === '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î' ? 'bg-emerald-600' : 'bg-blue-600';
                    payBadge = `<span class="text-[9px] ${payColor} text-white px-2 py-0.5 rounded-full font-bold ml-1">${order.payment}</span>`;
                }

                let slipButton = "";
                if(order.slipUrl) {
                    slipButton = `<a href="${order.slipUrl}" target="_blank" class="flex items-center justify-center gap-2 w-full py-2 mb-3 bg-blue-50 text-blue-600 border border-blue-200 rounded-xl text-xs font-bold hover:bg-blue-100 transition"><span>üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</span></a>`;
                }

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="text-4xl font-black ${isDone ? 'text-slate-600' : (isProc ? 'text-green-600' : 'text-slate-800')}">
                                ${order.prefix || (isPre ? 'P' : 'W')}${String(order.queueNo).padStart(3, '0')}
                            </span>
                            <div class="mt-1 flex items-center">
                                <span class="text-[9px] px-2 py-0.5 rounded-full font-bold ${isPre ? 'bg-blue-100 text-blue-600' : 'bg-orange-100 text-orange-600'}">
                                    ${type.toUpperCase()}
                                </span>
                                ${payBadge}
                            </div>
                        </div>
                        <span class="text-[10px] text-slate-400 font-bold">${order.time || ''}</span>
                    </div>
                    <p class="font-bold text-xl mb-1 truncate">${order.customerName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</p>
                    <div class="space-y-2 my-4 border-y py-3 ${isDone ? 'border-slate-700' : 'border-slate-100'} flex-grow">
                        ${(order.items || []).map(i => `
                            <div class="text-sm">
                                <b class="${isDone ? 'text-slate-500' : 'text-slate-800'}">ü•§ ${i.drink}</b>
                                <p class="text-[10px] opacity-60 ml-5 italic leading-tight">+ ${(i.toppings || []).join(', ') || '‡πÑ‡∏°‡πà‡∏°‡∏µ'}</p>
                            </div>
                        `).join('')}
                    </div>
                    ${slipButton}
                    <div class="flex justify-between items-center mb-5">
                        <span class="text-xs font-bold opacity-50 uppercase">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span>
                        <b class="text-2xl font-black ${isDone ? 'text-slate-500' : 'text-slate-800'}">${order.totalPrice || 0}.-</b>
                    </div>
                    <div class="flex flex-col gap-2">
                        ${!isDone ? `
                            ${!isProc ? `<button onclick="updateStatus('${key}', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∏‡∏á')" class="bg-slate-800 text-white py-3 rounded-2xl font-bold hover:bg-slate-700 transition shadow-lg">‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥)</button>` : 
                                       `<button onclick="updateStatus('${key}', '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß')" class="bg-green-500 text-white py-4 rounded-2xl font-black text-lg transition shadow-lg animate-pulse">‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß)</button>`}
                            <button onclick="cancelOrder('${key}')" class="py-2 text-red-400 text-xs font-bold hover:bg-red-50 rounded-xl transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏¥‡∏ß</button>
                        ` : `
                            <div class="text-center py-2 bg-slate-700 rounded-xl text-green-400 text-xs font-bold uppercase tracking-widest border border-slate-600">Completed ‚úÖ</div>
                            <button onclick="updateStatus('${key}', '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')" class="text-slate-500 text-[10px] py-1 hover:underline">‡∏î‡∏∂‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß</button>
                        `}
                    </div>
                `;
                container.appendChild(card);
            });

            if (count === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-20 text-slate-600 italic">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ</div>`;
            }
        }

        function updateStatus(key, status) {
            db.ref('orders/' + key).update({ status: status });
        }

        async function cancelOrder(key) {
            if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏ô‡∏µ‡πâ?")) {
                const order = allOrders[key];
                if(order.storagePath) {
                    try { await storage.ref(order.storagePath).delete(); } catch(e){}
                }
                db.ref('orders/' + key).update({ status: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' });
            }
        }

        async function resetDaily() {
            if(confirm("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà? ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏•‡∏¥‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Cloud")) {
                const keys = Object.keys(allOrders);
                for(let key of keys) {
                    if(allOrders[key].storagePath) {
                        try { await storage.ref(allOrders[key].storagePath).delete(); } catch(e){}
                    }
                }
                db.ref('last_p_queue').set(0);
                db.ref('last_w_queue').set(0);
                db.ref('orders').remove();
                alert("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß");
            }
        }
    </script>
</body>
</html>